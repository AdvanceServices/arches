<!--
ARCHES - a program developed to inventory and manage immovable cultural heritage.
Copyright (C) 2013 J. Paul Getty Trust and World Monuments Fund

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of the
License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program. If not, see <http://www.gnu.org/licenses/>.
-->
{% extends "base-manager.htm" %}
{% load staticfiles %}
{% load i18n %}

{% block graph_title %}
<div class="ep-tools-title">
    <h1 class="page-header text-overflow mobile-designer-title">
        <span data-bind="text: mobilesurvey.name()"></span>
    </h1>
</div>
{% endblock graph_title %}

{% block main_content %}
<div class="content-panel mobile-project-manager-editor">
    <div class="flex">

        <!-- Left Panel -->
        <div class="left-panel graph-designer msm-tree" data-bind="resizableSidepanel:true">
            <div class="" data-bind="with: tree" style="height: inherit">
                {% include 'views/mobile-survey-manager/mobile-survey-tree.htm' %}
            </div>
        </div>


        <div class="msm-designer-panel">
            <div>
                <div>
                    <!-- Header -->
                    <div class="relative library-header" style="height: 55px;">

                        <!-- Add Project -->
                        <div>
                            <!--ko if: mobilesurvey-->
                            <ul class="msm-edit-buttons mobile-project-category-header">
                                <!--ko if: selectedNode().selected()-->
                                <li data-bind="text: selectedNode().namelong"></li>
                                <li class="description" data-bind="text: selectedNode().description"></li>
                                <!--/ko-->
                            </ul>
                            <ul class="msm-edit-buttons">
                                <button class="btn btn-mint btn-labeled btn-active-dark fa fa-undo" data-bind="click: discardEdits, css: {'disabled': mobilesurvey.dirty()==false}">{% trans 'Discard Edits' %}</button>
                                <button id="btn-save-edits" class="btn btn-primary btn-labeled btn-active-dark fa fa-check" data-bind="click: saveMobileSurvey, css: {'disabled': mobilesurvey.dirty()==false}">{% trans 'Save Edits' %}</button>
                            </ul>
                            <!--/ko-->
                        </div>
                    </div>

                    <div style="display:none;" data-bind="visible: true">
                        <!-- ko if: mobilesurvey -->
                        <!--Project Details-->
                        <div style="padding: 0px; margin: 0px;">
                            <div id="cards" style="margin: 0px; margin-top: 0px;">

                                <!--Tabs Content-->
                                <div style="margin-left: 0px;">


                                    <!-- Summary Card -->
                                    <!--ko if: activePage() === 'root'-->
                                    <div id="project-summary-card" class="mpm-card">
                                        <div class="panel-body" style="">
                                            <div id="" class="card-content" style="">

                                                <!-- Project Summary Panel -->
                                                <div class="mpm-activation-panel">
                                                    <!--ko if: surveyReady().incomplete -->
                                                    <div class="mpm-item-listing-header"><i class="fa fa-exclamation-triangle" style="color:orange; padding-right:5px;"></i>{% trans 'Survey Status' %}</div>
                                                    <div class="mpm-card-content">
                                                        <div style="padding-left: 10px; padding-bottom: 10px;">{% trans 'You wonâ€™t be able to activate this survey until you have addressed the following items:' %}</div>
                                                        <ul>
                                                            <li data-bind = "visible: surveyReady().cards == false">{% trans 'Select the Model(s) and associated data entry cards to include in the survey' %}</li>
                                                            <li data-bind = "visible: surveyReady().identities == false">{% trans 'Select the People that you want to invite to the survey' %}</li>
                                                            <li data-bind = "visible: surveyReady().daterange == false">{% trans 'Define the start and end dates of your survey' %}</li>
                                                            <li data-bind = "visible: surveyReady().mapsources == false">{% trans 'Define either an online or offline basemap source' %}</li>
                                                            <li data-bind = "visible: surveyReady().bounds == false">{% trans 'Define a map extent' %}</li>
                                                        </ul>
                                                    </div>
                                                    <!--/ko-->

                                                    <!-- Activate Project -->
                                                    <div class="row pad-btm">
                                                        <!-- Activate Switch -->
                                                        <div class="col-sm-5 col-md-3">

                                                            <div class="box-inline">
                                                                <p class="mpm-item-listing-header" style="margin-bottom: 0px;">{% trans 'Activate Survey' %}</p>

                                                                <div class="toggle-container">
                                                                    <span class="switch switch-small" data-bind="css: {'on': mobilesurvey.active(), 'disabled': surveyReady().incomplete}, click: function(){
                                                                        if (!surveyReady().incomplete) {mobilesurvey.active(!mobilesurvey.active())};}"><small></small>
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="col-sm-6 col-md-9">
                                                            <p class="account-tips" style="margin-top: 20px;">
                                                                By activating the survey you will send users an email with the information needed to begin data editing activitites.
                                                            </p>
                                                        </div>
                                                    </div>

                                                    <!-- Survey Summary -->
                                                    <div class="msm-settings-summary">

                                                        <!-- Survey Settings -->
                                                        <div class="mpm-summary-panel">
                                                            <p class="mpm-item-listing-header" style="margin-bottom: 0px;">
                                                                {% trans 'Summary' %}
                                                            </p>
                                                            <ul class="mpm-node-detail-metadata">
                                                                <li class="">
                                                                    Number of edits: 0
                                                                </li>
                                                                <li class="">
                                                                    Contributors: 0
                                                                </li>
                                                                <li class="">
                                                                    Offline Basemap: Streets-Grey
                                                                </li>
                                                            </ul>
                                                        </div>

                                                        <!-- User Summary -->
                                                        <div class="mpm-summary-panel">
                                                            <p class="mpm-item-listing-header" style="margin-bottom: 0px;">
                                                                {% trans 'Groups/Users' %}
                                                            </p>
                                                            <ul class="mpm-node-detail-metadata">
                                                                <li class="">
                                                                    {% trans 'Groups' %} (<span data-bind="text: mobilesurvey.approvedGroupNames().length"></span>)
                                                                    <ul class="mpm-node-detail-metadata">
                                                                        <li class="" data-bind="text:  mobilesurvey.approvedGroupNames().join(', ')">
                                                                        </li>
                                                                    </ul>
                                                                </li>
                                                            </ul>
                                                            <ul class="mpm-node-detail-metadata">
                                                                <li class="">
                                                                    {% trans 'Users' %} (<span data-bind="text: mobilesurvey.approvedUserNames().length"></span>)
                                                                    <ul class="mpm-node-detail-metadata">
                                                                        <li class="" data-bind="text: mobilesurvey.approvedUserNames().join(', ')">

                                                                        </li>
                                                                    </ul>
                                                                </li>
                                                            </ul>
                                                        </div>

                                                        <div class="mpm-summary-panel">
                                                            <p class="mpm-item-listing-header" style="margin-bottom: 0px;">
                                                                {% trans 'Models and Data Entry Cards' %}
                                                            </p>
                                                            <!--ko if: selectedResources -->
                                                            <!--ko foreach: {data: selectedResources, as: 'resource'} -->
                                                            <ul class="mpm-node-detail-metadata">
                                                                <li class="">
                                                                    <div data-bind="text: resource.name + ' (' + resource.cards().length + ' data entry cards)'"></div>
                                                                    <!--ko foreach: {data: resource.cards, as: 'card'} -->
                                                                    <ul class="mpm-node-detail-metadata">
                                                                        <!--ko if: card.approved -->
                                                                        <li data-bind="text: card.name"></li>
                                                                        <!--/ko-->
                                                                    </ul>
                                                                    <!--/ko-->
                                                                </li>
                                                            </ul>
                                                            <!--/ko-->
                                                            <!--/ko-->
                                                            <!--ko ifnot: selectedResources.length > 0 -->
                                                            <ul class="mpm-node-detail-metadata">
                                                                <li class="">
                                                                    <div>{% trans 'No forms selected' %}</div>
                                                                </li>
                                                            </ul>
                                                            <!--/ko-->
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--/ko-->

                                    <!-- Summary Card -->
                                    <!--ko if: activePage() === 'settings'-->
                                    <div id="summary-card" class="mpm-card" style="">
                                        
                                        <div class="panel-body project-card-body">
                                            <div id="" class="card-content">

                                                <!-- Project Info -->
                                                <section id="" class="profile-list edit-mode">
                                                    <div class="account-wrapper">
                                                        <div class="row relative">

                                                            <!-- Section Content -->
                                                            <div class="col-sm-12">

                                                                <div id="account-crud" class="" style="">
                                                                    <div class="row">
                                                                        <div class="col-sm-5">
                                                                            <div class="form-group">
                                                                                <label class="control-label account-label">{% trans 'Survey name' %}</label>
                                                                                <input type="text" class="form-control input-lg account-input" data-bind="value: mobilesurvey.name, valueUpdate: 'keyup'">
                                                                            </div>
                                                                        </div>

                                                                        <div class="col-sm-6">
                                                                            <p class="account-tips">
                                                                                {% trans 'Pick a concise name that makes it easy for people to find your survey' %}
                                                                            </p>
                                                                        </div>
                                                                    </div>

                                                                    <hr style="border-color: #eee;">

                                                                    <div class="row">
                                                                        <div class="col-sm-5">
                                                                            <div class="form-group">
                                                                                <label class="control-label account-label">{% trans 'Survey start date' %}</label>
                                                                                <input class="form-control input-lg account-input" data-bind="datepicker: {format: dateFormat, minDate: false, maxDate: mobilesurvey.enddate}, value: mobilesurvey.startdate">
                                                                            </div>
                                                                        </div>
                                                                        
                                                                        <div class="col-sm-6">
                                                                            <p class="account-tips">
                                                                                {% trans 'The survey start and end dates are used to limit when people can add or edit Arches data.' %}
                                                                            </p>
                                                                        </div>
                                                                    </div>

                                                                    <div class="row">
                                                                        <div class="col-sm-5">
                                                                            <div class="form-group">
                                                                                <label class="control-label account-label">{% trans 'Survey end' %}</label>
                                                                                <input class="form-control input-lg account-input" data-bind="datepicker: {format: dateFormat, minDate: mobilesurvey.startdate, maxDate: false}, value: mobilesurvey.enddate">
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                    <hr style="border-color: #eee;">

                                                                    <div class="row">
                                                                        <div class="col-sm-12">
                                                                            <div class="form-group">
                                                                                <label class="control-label account-label">{% trans 'Description' %}</label>
                                                                                <div>
                                                                                    <textarea class="form-control textarea textarea-resizable" rows="3" type="text" data-bind="value: mobilesurvey.description, valueUpdate: 'keyup'"></textarea>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </section>
                                            </div>
                                        </div>
                                    </div>
                                    <!--/ko-->

                                    <!--ko if: activePage() === 'mapextent'-->
                                    <div class="mapboxgl-map map-search-container">
                                        <div class="msm-map-container">
                                          <!-- ko component: {
                                              name: 'map-widget',
                                              params: {
                                                type: 'survey-bounds',
                                                configForm: false,
                                                node: null,
                                                value: mobilesurvey.bounds,
                                                state: 'form',
                                                config: {
                                                    basemap: basemap.name,
                                                    bearing: 0,
                                                    centerX: defaultCenterX,
                                                    centerY: defaultCenterY,
                                                    featureColor: "rgba(55,32,196,0.85)",
                                                    featureEditingDisabled: false,
                                                    featureLineWidth: 2,
                                                    featurePointSize: 6,
                                                    geocodePlaceholder: "Locate a Place or Address",
                                                    geocodeProvider: geocoderDefault,
                                                    geocoderVisible: true,
                                                    geometryTypes: [{'id':'Polygon','text':'Polygon'}],
                                                    mapControlsHidden: false,
                                                    maxZoom: mapDefaultMaxZoom,
                                                    minZoom: mapDefaultMinZoom,
                                                    overlayConfigs: [],
                                                    overlayOpacity: 0,
                                                    pitch: 0,
                                                    zoom: mapDefaultZoom
                                                }
                                            }
                                          } --><!-- /ko -->
                                        </div>
                                    </div>
                                    <!--/ko-->

                                    <!--ko if: activePage() === 'mapsources'-->
                                    <div class="mpm-card msm-location-card ">
                                        <div class="panel-body project-card-body">
                                            <div class="col-sm-12 msm-basemap-location">
                                                <div class="form-group" style="margin-bottom: 10px;">
                                                    <label class="control-label account-label">{% trans 'Basemap location (MBTiles file url)' %}</label>
                                                    <input type="text" class="form-control input-lg" data-bind="value: mobilesurvey.tilecache, valueUpdate: 'keyup'">
                                                </div>
                                            </div>
                                            <div class="col-sm-12 msm-basemap-location">
                                                <div class="form-group" style="margin-bottom: 0px;">
                                                    <label class="control-label account-label">{% trans 'Online Basemap URL' %}</label>
                                                    <input type="text" class="form-control input-lg" data-bind="value: mobilesurvey.onlinebasemap, valueUpdate: 'keyup'">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--/ko-->

                                    <!--ko if: activePage() === 'resourcemodel'-->
                                    <div class="mpm-card-content">
                                        <div style='padding-bottom: 10px; font-weight: 550'>{% trans 'Data entry cards selected for this survey:' %}</div>
                                        <ul style="list-style-type: none;">
                                            <!--ko if: selectedNode().cards -->
                                            <!--ko foreach: {data: selectedNode().cards, as: 'card'} -->
                                                <li style="display:flex; align-items:center; padding">
                                                    <input style="height:15px; width:15px; padding-right: 10px" type="checkbox" value="card.approved" data-bind="checked: card.approved"/>
                                                    <span data-bind="text: card.name"></span>
                                                </li>
                                            <!--/ko-->
                                            <!--/ko-->
                                        </ul>
                                    </div>
                                    <!--/ko-->

                                    <!-- Models Card -->
                                    <!--ko if: activePage() === 'models'-->
                                    <div class="mpm-card-content">
                                        <!-- Splash Title -->
                                        <div class="title">{% trans "Mobile Data Collection" %}</div>
                                        <div class="sub-title">{% trans "Define the resource types for your survey" %}</div>
                                        <div class="mpm-resource-selection">
                                            <div class="resource-dropdown">
                                                <input style="width:30%; display:inline-block;"
                                                data-bind="select2Query: {
                                                    select2Config: getSelect2ResourcesConfig()
                                                }">
                                            </div>
                                        </div>
                                        <!-- Splash Instructions -->
                                        <div class="description">{% trans "Arches allows you to create and edit data in the field using mobile devices. Select those resources that should participate in the survey." %}</div>
                                    </div>
                                    <!--/ko-->
                                    <!-- End Models Card -->

                                    <!-- Data Card -->
                                    <!--ko if: activePage() === 'data'-->
                                    <div class="mpm-card">
                                        <div class="panel-body project-card-body">
                                            <div class="card-content">
                                                <div class="mpm-activation-panel">
                                                    <div class="row pad-btm">
                                                        <!-- Activate Switch -->
                                                        <div class="col-sm-5 col-md-3">

                                                            <div class="box-inline">
                                                                <p class="mpm-item-listing-header data-panel" style="margin-bottom: 0px;">
                                                                    {% trans 'Allow users to download data' %}
                                                                </p>

                                                                <div class="toggle-container">
                                                                    <span class="switch switch-small" data-bind="css: {'on': mobilesurvey.datadownloadconfig.download()}, click: function(){
                                                                        mobilesurvey.datadownloadconfig.download(!mobilesurvey.datadownloadconfig.download());
                                                                    }"><small></small></span>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Help Message-->
                                                        <div class="col-sm-6 col-md-9">
                                                            <p class="account-tips" style="margin-top: 20px;">
                                                                {% trans 'Downloading data allows users to access and edit existing Arches information in the field' %}
                                                            </p>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- ko if: mobilesurvey.datadownloadconfig.download() -->
                                                    <div id="data-definition" class="mpm-summary-panel">

                                                        <!-- Download Selector -->
                                                        <div class="msm-download-selector" style="display: block;">
                                                            <div id="standard-download" class="category-title" href="" data-bind="css: {active: mobilesurvey.showCustomDataDownload() === false }, click: function(){ mobilesurvey.showCustomDataDownload(false)}">{% trans 'Download Records' %}</div>
                                                            <div id="custom-download" class="category-title" href="" data-bind="css: {active: mobilesurvey.showCustomDataDownload() === true}, click: function(){ mobilesurvey.showCustomDataDownload(true)}">{% trans 'Custom Download' %}</div>
                                                        </div>

                                                        <!-- Standard Download -->
                                                        <div id="standard-download-panel" class="msm-download-panel" data-bind="visible: mobilesurvey.showCustomDataDownload() === false">

                                                            <p class="text-muted">
                                                                {% trans "Allow users to download instances for the resource models you've associated with this project." %}
                                                            </p>
                                                            <label style="display:flex; align-items:center">{% trans 'Limit ' %}<input type="number" class="form-control" style="width: 100px; margin-left: 7px;" placeholder="Search query URL" data-bind="textInput: mobilesurvey.datadownloadconfig.count"></input></label>
                                                            <div class="form-group pad-ver msm-data-selection">
                                                                <!-- Inline Checkboxes -->
                                                                <div class="checkbox">
                                                                    <!-- ko foreach: {data:allResources, as: 'resource'} -->
                                                                    <label class="form-checkbox form-normal form-primary" data-bind="text: resource.name, css: {'form-text' : true, active: _.contains($parent.mobilesurvey.datadownloadconfig.resources(), resource.id), disabled: resource.hasApprovedCards() === false}, click: function(r){if (r.hasApprovedCards()){$parent.mobilesurvey.updateResourceDownloadList(r)}}"><input type="checkbox"></label>
                                                                    <!-- /ko -->
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Custom Query -->
                                                        <div id="custom-download-panel" class="msm-download-panel" data-bind="visible: mobilesurvey.showCustomDataDownload() === true">
                                                            <p class="text-muted">
                                                                {% trans 'To define records for download' %} <strong> {% trans 'copy and paste the URL from Arches search page' %}</strong>
                                                            </p>

                                                            <div class="form-group">
                                                                <input type="text" id="" class="form-control" placeholder="Search query URL" data-bind="textInput: mobilesurvey.datadownloadconfig.custom">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!-- /ko -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--/ko-->

                                    <!--ko if: activePage() === 'people'-->
                                    <div id="models-card">
                                        <div class="mpm-card-content">
                                            <!-- Splash Title -->
                                            <div class="title">{% trans "Mobile Data Collection" %}</div>
                                            <div class="sub-title">{% trans "Define the user groups participating in your survey" %}</div>
                                            <div class="mpm-resource-selection">
                                                <div class="resource-dropdown">
                                                    <input style="width:30%; display:inline-block;"
                                                    data-bind="select2Query: {
                                                        select2Config: getSelect2GroupsConfig()
                                                    }">
                                                </div>
                                            </div>
                                            <!-- Splash Instructions -->
                                            <div class="description">{% trans "Arches allows you to create and edit data in the field using mobile devices. Select those people that should participate in the survey" %}</div>
                                        </div>
                                    </div>
                                    <!--/ko-->

                                    <!--ko if: activePage() === 'identity'-->
                                    <div id="models-card">
                                        <div class="mpm-card-content group-page">
                                            <div style="display: flex">
                                                <div style="display: flex; flex-direction: column; flex: 1;">
                                                    <div class="list-filter mpm-group-panel-header" style="display: flex; align-items: center;">
                                                        <span class="msm-identity-filter">
                                                            <input type="text" class="form-control" style="width: 100%;" placeholder="{% trans 'Find a user...' %}" data-bind="textInput: mobilesurvey.userFilter">
                                                            <span class="clear-node-search" data-bind="visible: true, click: function() { mobilesurvey.userFilter(''); }"><i class="fa fa-times-circle"></i></span>
                                                        </span>
                                                        <a class="filter-tools" data-bind="click: selectAllGroupUsers"><i class="ion-checkmark"></i>{% trans 'Select all' %}</a>
                                                        <a class="filter-tools" data-bind="click: clearAllGroupUsers"><i class="ion-close"></i>{% trans 'Clear all' %}</a>
                                                    </div>
                                                
                                                    <div class="mpm-group-panel-content list">
                                                        <!--ko if: selectedNode().type === 'group' -->
                                                        <div style="border-top: solid 1px #ccc;">
                                                            <!--ko foreach: {data: selectedNode().fullusers, as: 'user'} -->
                                                            <div data-bind="click: function(){$parent.mobilesurvey.selectedUser(user); return true;};, css: {oddrow: ($parent.selectedNode().fullusers.indexOf(user) % 2 === 0), selected: user.id === $parent.mobilesurvey.selectedUser().id}, visible: user.filtered() === false" class="userrow">
                                                                <input style="height:15px; width:15px; margin-right: 5px;" type="checkbox" value="user.approved()" data-bind="checked: user.approved, event: {'change': $parent.mobilesurvey.toggleIdentity}" />
                                                                <span data-bind="text: user.name"></span>
                                                            </div>
                                                            <!--/ko-->
                                                        </div>
                                                        <!--/ko-->
                                                    </div>
                                                </div>

                                                <div style="display: flex; flex-direction: column; flex: 1; border-left: solid 1px #ccc;">
                                                    <div class="list-filter mpm-group-panel-header">
                                                        <h4>{% trans "Account Summary" %}</h4>
                                                    </div>
                                                    
                                                    <div class="mpm-group-panel-content">
                                                        <!--ko if: mobilesurvey.selectedUser() -->
                                                        <dl>
                                                            <dt>{% trans 'User Information' %}</dt>
                                                            <dd data-bind="text: mobilesurvey.selectedUser().first_name + ' ' + mobilesurvey.selectedUser().last_name"></dd>
                                                            <dd data-bind="text: mobilesurvey.selectedUser().name"></dd>
                                                            <dd data-bind="text: mobilesurvey.selectedUser().email"></dd>
                                                        </dl>
                                                        <!--/ko-->
                                                        
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--/ko-->

                                </div>
                            </div>
                        </div>    
                        <!-- /ko -->
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock main_content %}

{% block tabs %}{% endblock tabs %}

{% block pre_require_js %}
{{block.super}}
    <script>
        {% autoescape off %}define('mobile-survey-manager-data', [], function() {
            return {
                mobilesurvey: {{mobile_survey}},
                resources: {{resources}},
                identities: {{identities}}
            };
        });{% endautoescape %}
    </script>
{% endblock pre_require_js %}
