{% extends "views/components/iiif-viewer.htm" %}
{% load staticfiles %}
{% load i18n %}

{% block tabs %}
<div class="workbench-card-sidebar-tab" data-bind="click: function() {
    toggleTab('manifest');
}, css: {
    'active': activeTab() === 'manifest'
}">
    <i class="fa fa-book"></i>
    <span class="map-sidebar-text">{% trans "Manifest" %}</span>
</div>
<div class="workbench-card-sidebar-tab" data-bind="click: function() {
    toggleTab('canvas');
}, css: {'active': activeTab() === 'canvas', 'disabled': !canvas()
}">
    <i class="fa fa-book"></i>
    <span class="map-sidebar-text">{% trans "Canvas" %}</span>
</div>
{{ block.super }}
{% endblock tabs %}

{% block sidepanel %}
<!--ko foreach: { data: [$data], as: 'self' }-->
<!--ko if: activeTab() === 'manifest'-->
<div class="workbench-header-buffer">
    <div class="workbench-card-sidepanel-header-container">
        <h4 class="workbench-card-sidepanel-header" data-bind="click: hideSidePanel">{% trans 'Manage Manifest' %}</h4>
    </div>
</div>

<div class="iiif-image-tools">
    <div class="form-group">
        <label class="control-label">{% trans "Title" %}</label>
        <input type="text" placeholder="Manifest Title" class="form-control input-lg" style="height: 36px;"
            data-bind="textInput: self.manifestName, valueUpdate: 'keyup'">
        <label class="control-label">{% trans "Description" %}</label>
        <textarea rows="10" type="text" placeholder='Manifest Description' class="form-control input-lg"
            data-bind="textInput: self.manifestDescription, valueUpdate: 'keyup'"></textarea>

        <label class="control-label">{% trans "Metadata" %}</label>
        <div class="manifest-details-list">
            <label class="control-label">{% trans "Label" %}</label>
            <input type="text" placeholder='Metadata Label' class="form-control input-md" style="height: 36px;" 
                data-bind="textInput: metaDataLabel, valueUpdate: 'keyup'">
            <label class="control-label">{% trans "Values" %}</label>
            <input type="text" placeholder='Metadata Value' class="form-control input-md" style="height: 36px;" 
                data-bind="textInput: metaDataValues, valueUpdate: 'keyup'">
        </div>
    </div>


    <!--ko if: imagesForUpload().length > 0-->
    <label class="control-label">{% trans "Images to be Added" %}</label>
    <div class="file-workbench-files" data-bind="foreach: imagesForUpload">
        <div class='file-workbench-file' style="display: inline-flex;" data-bind="click: $parent.removeFile, clickBubble: false">
            <i class="fa fa-trash" style="margin: 0px 10px"></i>
            <span class='file-name' data-bind="text: name"></span>
        </div>
    </div>
    <!--/ko-->
    
    <div class="dropzone-photo-upload" data-bind="dropzone: dropzoneOptions4create">
        <div class="file-workbench-buttons" style="margin-bottom: 20px;">
            <button class="btn btn-primary btn-lg btn-block btn-labeled btn-workbench fa fa-file fileinput-create-button dz-clickable" data-bind="css: uniqueidClass">
                <span>{% trans "Create a new Manifest" %}</span>
            </button>
        </div>
        <div style="min-height: 100%;">
            <div id="hidden-dz-create-previews" style="display:none"></div>
        </div>
    <div class="install-buttons" style="display: inline-flex; justify-content: space-between;">
        <div style="display: flex;">
        <button class="btn btn-mint btn-md btn-labeled fa fa-pencil" style="width: auto; margin-right: 10px;" data-bind="click: updateManifest, clickBubble: false, disable: !isManifestDirty()">{% trans "Save" %}</button>
        <button class="btn btn-warning btn-md btn-labeled fa fa-refresh" style="width: auto; margin-right: 10px;" data-bind="click: reset, clickBubble: false, disable: !isManifestDirty()">{% trans "Cancel" %}</button>
        </div>
        <!--ko if: manifest-->
        <button class="btn btn-danger btn-md btn-block btn-labeled btn-workbench fa fa-trash" style="width: auto" data-bind="click: deleteManifest"><span>{% trans "Delete" %}</span></button>
        <!--/ko-->
    </div>
</div>
<!--/ko-->

<!--ko if: activeTab() === 'canvas'-->
<div class="workbench-header-buffer">
    <div class="workbench-card-sidepanel-header-container">
        <h4 class="workbench-card-sidepanel-header" data-bind="click: hideSidePanel">{% trans 'Manage Canvases' %}</h4>
    </div>
</div>

<div class="iiif-image-tools">
    <!--ko if: canvases().length > 0-->
    <label class="control-label">{% trans "Canvases" %}</label>
    <div>{% trans "Select canvas to delete from the manifest" %}</div>
    <div class="file-workbench-files" data-bind="foreach: canvases">
        <div class='file-workbench-file' style="display: inline-flex;" data-bind="css: {staged: ko.unwrap($parent.canvas) === $data.images[0].resource.service['@id']}">
            <input type="checkbox" style="width:1em; height:1em;" data-bind="value: $data, checked: $parent.canvasesForDeletion">
            <!--ko if: ko.unwrap($parent.canvas) === $data.images[0].resource.service['@id'] -->
            <span class='file-name' data-bind="text: $parent.canvasLabel, click: $parent.canvasClick, clickBubble: false"></span>
            <!--/ko-->
            <!--ko ifnot: ko.unwrap($parent.canvas) === $data.images[0].resource.service['@id'] -->
            <span class='file-name' data-bind="text: label, click: $parent.canvasClick, clickBubble: false"></span>
            <!--/ko-->
        </div>
    </div>

    <div class="file-workbench-buttons">
        <button style="width: 50%; margin: 10px 2px 20px 0px;" class="btn btn-md btn-primary" data-bind="click: addAllCanvases"
        ><i class="fa fa-check-square"></i> {% trans 'Select All' %}</button>
        <button style="width: 50%; margin: 10px 0px 20px 2px;" class="btn btn-md btn-primary" data-bind="click: clearCanvasSelection, css: {
            disabled: canvasesForDeletion().length === 0
        }"><i class="fa fa-eraser"></i> {% trans 'Clear All' %}</button>
    </div>
    <div class="file-workbench-selected-buttons" data-bind="visible: canvasesForDeletion().length > 0">
        <button class="btn btn-lg btn-workbench btn-danger" data-bind="click: deleteCanvases"><i class="fa fa-trash"></i> {% trans 'Delete Selected' %}</button>
    </div>

    <!--ko if: canvas-->
    <label class="control-label">{% trans "Image Information" %}</label>
    <div>
        <input type="text" placeholder='Image Caption' class="form-control input-lg" style="height: 36px;" 
        data-bind="textInput: self.canvasLabel, valueUpdate: 'keyup'">
    </div>
    <!--/ko-->
    <!--/ko-->
        
    <!--ko if: imagesForUpload().length > 0-->
    <label class="control-label">{% trans "Images to be Added" %}</label>
    <div class="file-workbench-files" data-bind="foreach: imagesForUpload">
        <div class='file-workbench-file' style="display: inline-flex;" data-bind="click: $parent.removeFile, clickBubble: false">
            <i class="fa fa-trash" style="margin: 0px 10px"></i>
            <span class='file-name' data-bind="text: name"></span>
        </div>
    </div>
    <!--/ko-->


    <div class="dropzone-photo-upload" data-bind="dropzone: dropzoneOptions">
        <div class="file-workbench-buttons">
            <button class="btn btn-primary btn-lg btn-block btn-labeled btn-workbench fa fa-file fileinput-button dz-clickable" data-bind="css: uniqueidClass">
                <span>{% trans "Add Photos" %}</span>
            </button>
        </div>
        <div style="min-height: 100%;">
            <div id="hidden-dz-previews" style="display:none"></div>
        </div>
    </div>
    <div class="install-buttons" style="display: inline-flex; justify-content: space-between;">
        <div class="file-workbench-buttons">
            <button class="btn btn-mint btn-md btn-labeled fa fa-pencil" data-bind="click: updateManifest, clickBubble: false, disable: !isCanvasDirty()">{% trans "Save" %}</button>
            <button class="btn btn-warning btn-md btn-labeled fa fa-refresh" data-bind="click: reset, clickBubble: false, disable: !isCanvasDirty()">{% trans "Cancel" %}</button>
        </div>
    </div>
</div>
<!--/ko-->
<!--/ko-->
{{ block.super }}
{% endblock sidepanel %}

{% block content_management %}
<!-- ko foreach: { data: [$data], as: 'self' } -->

<!-- ko if: mainMenu() -->
<div class="bord-top file-select loader-select" style="height: 100%;">
    <div class="">
        <h2>{% trans 'IIIF Manifest Manager' %}</h2>
        <h4>{% trans 'Create a new manifest or modify an existing one' %}</h4>
        <div style="display: flex; padding: 15px 25px; justify-content: center;">
        <div style="width: 620px; display:flex; justify-content:space-between;">
            <div class="r-grid-item relative" style="border: 1px solid #c4c4c4">
                <div class="" style="display:flex; flex-direction: column; background-color: #fdfdfd">
                    <h4 class="r-select-title">{% trans 'Select a Manifest' %}</h4>
                </div>
                <div>
                    <div class="r-select-card" style="color: #30517a; background-color: #fdfdfd">
                        <div class="r-select-circle loader-button" style="top: 55px">
                            <span><i class="fa fa-pencil r-select-icon"></i></span>
                        </div>
                        <div class="r-desc-container">
                            <p style="color: #30517a; background-color: #fdfdfd" class="r-select-desc">{% trans 'Choose an existing manifest to edit' %}</p> 
                        </div>  
                    </div>
                </div>

                <!-- card Tools -->
                <div class="r-select-card-footer">
                    <div class="">
                        <div data-bind="click: function(){self.mainMenu(false);}" style="border-top: 1px solid #c4c4c4;" class="btn btn-primary btn-resource-select" role="button">
                        {% trans 'Select' %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="r-grid-item relative" style="border: 1px solid #c4c4c4">
                <div class="" style="display:flex; flex-direction: column; background-color: #fdfdfd">
                    <h4 class="r-select-title">{% trans 'Create a New Manifest' %}</h4>
                </div>
                <div>
                    <div class="r-select-card" style="color: #30517a; background-color: #fdfdfd">
                        <div class="r-select-circle loader-button" style="top: 55px">
                            <span><i class="fa fa-upload r-select-icon"></i></span>
                        </div>
                        <div class="r-desc-container">
                            <p style="color: #30517a; background-color: #fdfdfd" class="r-select-desc">{% trans 'Add files to create a new manifest' %}</p> 
                        </div>  
                    </div>
                </div>

                <!-- card Tools -->
                <div class="r-select-card-footer" class="dropzone-photo-upload" data-bind="dropzone: dropzoneOptions4create">
                    <div class="">
                        <div style="border-top: 1px solid #c4c4c4;" class="btn btn-primary btn-resource-select fileinput-create-button dz-clickable" data-bind="css: uniqueidClass" role="button">
                        {% trans 'Select' %}
                        </div>
                    </div>
                    <div style="min-height: 100%;">
                        <div id="hidden-dz-create-previews" style="display:none"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<!--/ko-->


<!-- ko if: !mainMenu() -->
<div class="workbench-card-container" data-bind="css: {
        'gallery-visible': showGallery,
        'gallery-expanded': expandGallery
    }">
    <div class="iiif-leaflet" data-bind="leaflet: leafletConfig"></div>
</div>
<div class="show-gallery-control" data-bind="css: {
        'gallery-visible': showGallery,
        'gallery-expanded': expandGallery
    }">
    <i class="fa" data-bind="css: {
        'fa-chevron-circle-up': !expandGallery(),
        'fa-chevron-circle-down': expandGallery()
    }, click: function() { expandGallery(!expandGallery()); }"></i>
    <h3>{% trans "Gallery" %}</h3>
    <a href="javascript: void(0)" data-bind="
        click: toggleGallery,
        text: showGallery() ? '{% trans "hide" %}' : '{% trans "show" %}'
    "></a>
    
    <!--ko if: expandGallery() -->
    <span style="padding-right: 3px; padding-left: 3px;">|</span>
    <a href="">{% trans "close info" %}</a>
    <!--/ko -->

</div>
<!--ko let: {canvasClick: canvasClick, getCanvasService: getCanvasService, selectedCanvas: canvas, getAnnotationCount: getAnnotationCount} -->
<div class="iiif-viewer-gallery" data-bind="css: {
        'gallery-expanded': expandGallery
    }">
    <!--ko if: showGallery() -->
    <div class="iiif-gallery-content">

        <!--ko if: expandGallery() && manifestData() -->
        <div class="manifest-details">
            <h3>
                <span data-bind="text: manifestName"></span>
            </h3>

            <h4>
                <span data-bind="text: manifestDescription"></span>
            </h4>

            <div class="manifest-details-list" data-bind="foreach: manifestMetaData">
                <dt class="manifest-metadata-title" data-bind="text: label"></dt>
                <!--ko foreach: Array.isArray(value) ? value : [value] -->
                <dd class="manifest-metadata-value" data-bind="html: $data"></dd>
                <!--/ko -->
            </div>
            <h4 data-bind="text: manifestData().attribution || ''"></h4>
            <!--ko if: manifestData().logo -->
            <img class="manifest-logo" data-bind="attr: {src: typeof manifestData().logo === 'string' ? manifestData().logo : manifestData().logo['@id']}">
            <!--/ko -->
        </div>
        <!--/ko -->

        <!--ko if: editManifest() -->
        <div class="manifest-editor">
            <div class="manifest-editor-label">
                {% trans "Select a manifest:" %}
            </div>
            <div class="manifest-editor-input">
                <input class="form-control input-lg widget-input"
                    data-bind="value: manifest,
                    select2Query: {
                        select2Config: manifestSelectConfig
                    }">
            </div>

            <div class="install-buttons">
                <button class="btn btn-shim btn-mint btn-labeled btn-lg fa fa-pencil" data-bind="click: getManifestData,
                    disabled: manifestLoading(),
                    css: { 'disabled': manifestLoading() }
                ">{% trans 'Update manifest' %}</button>
                <button class="btn btn-shim btn-danger btn-labeled btn-lg fa fa-refresh" data-bind="click: toggleManifestEditor">{% trans 'Cancel' %}</button>
                <!--ko if: manifestLoading() -->
                <span class="manifest-editor-loading">
                    {% trans "Loading manifest..." %}
                </span>
                <!--/ko -->
                <!--ko if: manifestError() -->
                <span class="manifest-editor-error">
                    {% trans "Error loading manifest..." %}
                </span>
                <!--/ko -->
            </div>
        </div>
            
            
        <!--/ko -->
        <!--ko if: !editManifest() -->
            <!--ko if: manifestLoading() -->
            <span class="manifest-editor-loading">
                {% trans "Loading manifest..." %}
            </span>
            <!--/ko -->
            <!--ko if: !manifestLoading() -->
            <div class="iiif-gallery-panel" style="overflow-x: auto;">
                <div class="iiif-gallery-header">
                    <span class="iiif-gallery-sequence-label" data-bind="click: toggleManifestEditor, text: manifestData() ? manifestName() : '{% trans "No manifest selected..." %}'"></span>
                    |
                    {% trans "Filter" %}
                    <div class="list-filter" data-bind="">
                        <input type="text" class="form-control" style="width: 100%;" placeholder="{% trans 'Filter images...' %}" data-bind="textInput: filter">

                        <!-- Clear Search -->
                        <span class="clear-node-search" data-bind="visible: filter().length > 0, click: function() { filter(''); }"><i class="fa fa-times-circle"></i></span>
                    </div>
                </div>

            <div class="iiif-gallery-sequence">
                <div class="iiif-gallery-sequence-canvases" data-bind="foreach: canvases">
                    <div class="iiif-gallery-canvas" data-bind="click: function() {
                        canvasClick($data);
                    },
                    visible: label.toLowerCase().includes(self.filter().toLowerCase()),
                    css: {
                        active: getCanvasService($data) === selectedCanvas(),
                        annotated: getAnnotationCount(getCanvasService($data))
                    }">
                        <div class="iiif-gallery-canvas-thumbnail">
                            <img data-bind="attr: { src: $data.thumbnail || '{% static 'img/photo_missing.png' %}', title: $data.label}">
                        </div>
                        <div class="iiif-gallery-canvas-label">
                            <!--ko if: getCanvasService($data) === selectedCanvas() -->
                            <span data-bind="text: $parent.canvasLabel"></span>
                            <!--/ko -->                                
                            <!--ko ifnot: getCanvasService($data) === selectedCanvas() -->
                            <span data-bind="text: label"></span>
                            <!--/ko -->                                
                            <span class="annotation-count">
                                <!--ko if: getAnnotationCount(getCanvasService($data)) -->
                                <span data-bind="text: getAnnotationCount(getCanvasService($data))"></span> {% trans "Annotation(s)" %}
                                <!--/ko -->
                                <!--ko if: !getAnnotationCount(getCanvasService($data)) -->
                                &nbsp;
                                <!--/ko -->
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            <!--/ko -->
        <!--/ko -->
    </div>
    <!--/ko -->
</div>
<!--/ko -->
<!--/ko -->
<!--/ko -->
{% endblock content_management %}