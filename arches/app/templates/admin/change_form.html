{% extends "admin/change_form.html" %}
{% load staticfiles %}
{% load template_tags %}
{% load i18n %}

{% block content %}
    {{ block.super }}

    {% if not request.session.has_cleared_cache %}
        <div
            class='foobar'
            style="
                position: fixed;
                width: 80vw;
                height: 80vh;
                background-color: red;
            "
        >
            <p>{% csrf_token %}<button onclick="foo(this)"></button></p>
        </div>
        <script type="text/javascript"> 
            function foo(self) {
                var xmlhttp = new XMLHttpRequest();
                var csrftoken=self.parentElement.firstChild.value

                xmlhttp.onreadystatechange = function() {
                    if (xmlhttp.readyState == XMLHttpRequest.DONE) {   // XMLHttpRequest.DONE == 4
                        if (xmlhttp.status == 200) {
                            var modal = document.querySelector('.foobar');
                            modal.style.display = "none";
                        }
                        else {
                            alert('An error occured when attempting to clear the User Permission Cache. This can cause issues throughout the application.');
                        }
                    }
                };

                xmlhttp.open("POST", "/clear-user-permission-cache/", true);
                xmlhttp.setRequestHeader("X-CSRFToken", csrftoken ); 
                xmlhttp.send();
            }
        </script>
    {% endif %}

{% endblock content %}